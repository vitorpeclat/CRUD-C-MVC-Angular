<div class="container mt-4">

  <div class="row mb-3 align-items-center">
    
    <div class="col-md-3">
      <button class="btn w-100" [ngClass]="exibirFormularioNovo ? 'btn-secondary' : 'btn-primary'" (click)="alternarNovoCadastro()">
        <strong>{{ exibirFormularioNovo ? '- Fechar' : '+ Novo Usu√°rio' }}</strong>
      </button>
    </div>

    <div class="col-md-9">
      <div class="input-group">
        <span class="input-group-text bg-white">üîç</span>
        <input 
          type="text" 
          class="form-control" 
          placeholder="Pesquisar por ID, Nome ou E-mail..." 
          [(ngModel)]="termoBusca" 
          (input)="filtrar()">
      </div>
    </div>
  </div>

  <div *ngIf="exibirFormularioNovo" [@expandirFechar] class="card mb-3 border-primary shadow-sm overflow-hidden">
    <div class="card-header bg-primary text-white">Novo Cadastro</div>
    <div class="card-body">
      <ng-container *ngTemplateOutlet="formTemplate"></ng-container>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-light"><strong>Lista de Usu√°rios</strong></div>
    <div class="card-body p-0">
      
      <table class="table table-bordered m-0 tabela-fixa">
        <thead class="table-dark">
          <tr>
            <th class="col-id">ID</th>
            <th class="col-nome">Nome</th>
            <th class="col-login">Login</th>
            <th class="col-email">Email</th>
            <th class="col-acoes">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let u of usuariosFiltrados">
            
            <tr [class.table-active]="idEdicao === u.id">
              <td class="text-truncate">{{ u.id }}</td>
              <td class="text-truncate" title="{{u.nome}}">{{ u.nome }}</td>
              <td class="text-truncate">{{ u.login }}</td>
              <td class="text-truncate" title="{{u.email}}">{{ u.email }}</td>
              <td class="text-center">
                <button class="btn btn-warning btn-sm me-2" (click)="editar(u)" [disabled]="idEdicao === u.id">‚úé</button>
                <button class="btn btn-danger btn-sm" (click)="excluir(u.id!)" [disabled]="idEdicao === u.id">üóë</button>
              </td>
            </tr>

            <tr *ngIf="idEdicao === u.id" class="bg-light">
              <td colspan="5" class="p-0 border-0">
                <div [@expandirFechar] class="overflow-hidden">
                  <div class="p-4 border border-warning m-2 shadow-sm bg-white rounded">
                    <div class="d-flex justify-content-between mb-3">
                      <h5 class="text-primary">Editando: {{ u.nome }}</h5>
                      <button class="btn btn-close" (click)="cancelar()"></button>
                    </div>
                    
                    <ng-container *ngTemplateOutlet="formTemplate"></ng-container>
                  </div>
                </div>
              </td>
            </tr>

          </ng-container>

          <tr *ngIf="usuariosFiltrados.length === 0">
            <td colspan="5" class="text-center p-3 text-muted">
              {{ usuarios.length === 0 ? 'Nenhum usu√°rio cadastrado.' : 'Nenhum resultado encontrado.' }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<ng-template #formTemplate>
  <form (ngSubmit)="salvar()">
    <div class="row">
      <div class="col-md-12 mb-3">
        <label class="form-label">Nome Completo</label>
        <input type="text" class="form-control" [(ngModel)]="usuarioAtual.nome" name="nome" required>
      </div>
      
      <div class="col-md-4 mb-3">
        <label class="form-label">Login</label>
        <input type="text" class="form-control" [(ngModel)]="usuarioAtual.login" name="login" required>
      </div>
      
      <div class="col-md-4 mb-3 input-container">
        <label class="form-label">Email</label>
        
        <div class="popup-erro" *ngIf="usuarioAtual.email && !validarEmail(usuarioAtual.email)">
          Formato inv√°lido: email@dominio.com
        </div>

        <input 
          type="email" 
          class="form-control" 
          [class.is-invalid]="usuarioAtual.email && !validarEmail(usuarioAtual.email)"
          [class.is-valid]="validarEmail(usuarioAtual.email)"
          [(ngModel)]="usuarioAtual.email" 
          name="email" 
          required>
      </div>
      
      <div class="col-md-4 mb-3 input-container">
        <label class="form-label">Senha</label>
        
        <div class="popup-erro" *ngIf="usuarioAtual.senha && !validarSenha(usuarioAtual.senha)">
          A senha deve ter letra Mai√∫scula, S√≠mbolo e 6 digitos.
        </div>

        <input 
          type="text" 
          class="form-control" 
          [class.is-invalid]="usuarioAtual.senha && !validarSenha(usuarioAtual.senha)"
          [class.is-valid]="validarSenha(usuarioAtual.senha)"
          [(ngModel)]="usuarioAtual.senha" 
          name="senha" 
          required 
          autocomplete="off">
        <small class="dica-senha">(Mai√∫scula + Especial + 6 digitos)</small>
      </div>
    </div>

    <div class="d-flex justify-content-between">
      <div>
        <button type="button" class="btn btn-outline-secondary" (click)="limpar()" *ngIf="!idEdicao">
          Limpar
        </button>
      </div>
      <div>
        <button type="button" class="btn btn-secondary me-2" (click)="cancelar()">Cancelar</button>
        <button type="submit" class="btn btn-success" [disabled]="!validarSenha(usuarioAtual.senha) || !validarEmail(usuarioAtual.email)">
          Salvar
        </button>
      </div>
    </div>
  </form>
</ng-template>